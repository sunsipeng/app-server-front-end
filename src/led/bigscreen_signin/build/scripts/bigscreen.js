define(function(require,exports,module){var Vue=require("./scripts/vue.js");require("./scripts/jquery.liMarquee.js"),require("./scripts/mqttws31.min.js");var config=require("./scripts/config.js"),util=require("./scripts/util.js"),vueParams=require("./scripts/vueParams.js");new Vue({el:"#bigScreenContainer",data:vueParams,beforeMount:function(){this.initComponent(),this.S=jQuery.noConflict(),this.promptContentWrapperWidth=481,this.titleWidth=522,this.timerTask()},watch:{},mounted:function(){this.time={yyyymmdd:util.timeFormatYYYYMMDD(),week:util.weekTime(),HHmmss:util.timeFormatHHmmss()},this.timeTimer=setInterval(function(){this.time={yyyymmdd:util.timeFormatYYYYMMDD(),week:util.weekTime(),HHmmss:util.timeFormatHHmmss()}}.bind(this),1e3)},methods:{init:function(){config.clientId=config.clientId+(new Date).getTime(),this.MQTTConnect(),this.getWeatherInfo(),this.getInitializationData(),this.peopleData=this.simulateSignData},MQTTConnect:function(){var username=config.accessKey,password=config.secretKey;this.mqttObj=new Paho.MQTT.Client(config.host,config.port,config.clientId);var self=this,options={timeout:3,onSuccess:self.MQTTConnectSuccess,onFailure:function(message){console.log(message),setTimeout(self.MQTTconnect,self.reconnectTimeout)}};this.mqttObj.onConnectionLost=this.MQTTConnectionLost,this.mqttObj.onMessageArrived=this.MQTTMessageArrived,null!=username&&(options.userName=username,options.password=password,options.useSSL=config.useTLS),this.mqttObj.connect(options)},MQTTConnectSuccess:function(){console.log("connect success.."),this.mqttObj.subscribe(config.topic,{qos:0})},MQTTMessageArrived:function(message){var topic=message.destinationName,payload=JSON.parse(message.payloadString);switch(console.log("recv msg : "+topic+"   "+payload),console.log(JSON.stringify(payload,null,3)),console.log("messgae: ",message),payload.action){case"IN":this.peopleSign(payload);break;case"OUT":this.peopleExit(payload);break;case"changeTips":this.messageCode==payload.msgCode&&(this.tipMessage=payload.tips,17*this.tipMessage.length>486?this.promptContentScrollIsOpeng||this.S("#promptContentWrapper").liMarquee({scrollamount:this.scrollTime,hoverstop:!1}):this.S("#promptContentWrapper").liMarquee()&&this.S("#promptContentWrapper").liMarquee().liMarquee("destroy"));break;case"changeTitle":this.messageCode==payload.msgCode&&(this.title=payload.title,17*this.title.length>486?this.titleContentScrollIsOpeng||this.S("#titleContent").liMarquee({scrollamount:this.scrollTime,hoverstop:!1}):this.this.S("#titleContent").liMarquee()&&this.S("#titleContent").liMarquee().liMarquee("destroy"))}},MQTTConnectionLost:function(response){setTimeout(this.MQTTConnect,this.reconnectTimeout)},getInitializationData:function(){var msgCode=util.getQueryString("msgCode");console.log(msgCode),this.S.ajax({type:"post",url:this.getInitDataURL,contentType:"application/json",crossDomain:!0,data:JSON.stringify({msgCode:msgCode}),success:function(data){if(console.log(JSON.stringify(data,null,3)),data.status>0){this.approachPeople=data.data.approachPersonnel,this.peopleLongitudinalList=data.data.depNumbers,this.peopleListLandscape=data.data.operatorNumbers,this.peopleScrollLandscapeWidth=146*data.data.operatorNumbers.length,this.title=data.data.title,this.tipMessage=data.data.tipMessage,this.approachpPeopleNum=data.data.totalNumber,this.messageCode=data.data.msgCode;var leaderstr="";data.data.leadersList.forEach(function(d){leaderstr+=d.userName+","}),this.weatherData.leader=leaderstr.substring(0,leaderstr.length-1),this.gateCode=data.data.currentGateCode,setTimeout(this.peopleListScroll,100)}else alert(data.message)}.bind(this),error:function(err){console.error(err)}})},initComponent:function(){Vue.component("default-dynamic",{template:'<div class="weather-wrapper">\t\t\t<p class="leader">带班领导：{{this.weather.leader}}</p>\t\t\t  <img :src="this.weather.icon"/>\t\t\t  <p>{{this.weather.desc}}</p>\t\t\t  <p>{{this.weather.temp}} ℃</p>\t\t\t  <p>{{this.weather.windDeg}}风 {{this.weather.windSpeed}}级</p>\t\t\t  <p></p>\t\t  </div>',props:{weather:{type:Object,default:{}}},data:function(){return{}}}),Vue.component("people-info",{template:'<div class="people-singin">\t\t\t<div class="user-icon">\t\t\t  <img :src="this.people.imagUrl"/>\t\t\t</div>\t\t\t<div class="user-info">\t\t\t <p :style=\'this.people.orgType == "Proprietor" ? "margin-top:66px" : ""\'>姓名：{{this.people.userName}}</p>'+"\t\t\t <p>性别：{{this.people.genderCode?'男':'女'}}</p>\t\t\t <p class='people-department-comp'>部门：{{this.people.orgName}}</p>\t\t\t <p class='people-department-comp'>职务：{{this.people.jobTitle?this.people.jobTitle:'暂无'}}</p>\t\t\t <p v-if='this.people.orgType !== \"Proprietor\"'>违章次数：{{this.people.peccancyNum}}次</p>\t\t\t <p v-if='this.people.orgType !== \"Proprietor\"'>剩余积分：{{this.people.score}}</p>\t\t\t</div>\t\t  </div>",props:{people:{type:Object,default:{}}},data:function(){return{}}})},getWeatherInfo:function(){var self=this;this.S.ajax({type:"get",url:this.weatherURL,data:{},success:function(data){self.weatherData.icon=String.format(self.weatherIconURL,data.weather[0].icon),self.weatherData.temp_min=data.main.temp_min,self.weatherData.temp_max=data.main.temp_max,self.weatherData.temp=data.main.temp,self.weatherData.desc=data.weather[0].description,self.weatherData.wind=data.weather[0].description,self.weatherData.windDeg=self.windDegConvert(data.wind.deg),self.weatherData.windSpeed=data.wind.speed}})},timerTask:function(){var timerTaskFlag=!0;this.requstDataTimer=setInterval(function(){var endMo=util.mo().format("YYYY-MM-DD")+" 00:00";util.mo().format("YYYY-MM-DD HH:mm")==endMo?timerTaskFlag&&(this.getInitializationData(),timerTaskFlag=!1):timerTaskFlag=!0}.bind(this),1e3)},windDegConvert:function(deg){return this.winDegConf[Math.round(deg%360/45)]},peopleListScroll:function(){this.calcPeopleScrollLandscapeWidth(),setTimeout(function(){this.S("#peopleScrollLongitudinal").liMarquee({direction:"up",scrollamount:this.scrollTime,hoverstop:!1}),this.S("#peopleScrollLandscape").liMarquee({scrollamount:this.scrollTime,hoverstop:!1}),this.S("#approachPeopleWrapper").liMarquee({direction:"up",scrollamount:this.scrollTime,hoverstop:!1}),17*this.tipMessage.length>486&&(this.S("#promptContentWrapper").liMarquee({scrollamount:this.scrollTime,hoverstop:!1}),this.promptContentScrollIsOpeng=!0),17*this.title.length>486&&(this.S("#titleContent").liMarquee({scrollamount:this.scrollTime,hoverstop:!1}),this.titleContentScrollIsOpeng=!0)}.bind(this),500)},updatePeopleListForLongitudinal:function(signData){this.S(".str_origin",this.S("#peopleScrollLongitudinal")).html(this.S(".str_origin",this.S("#peopleScrollLongitudinal")).html()+this.updateDom([{orgName:this.specialPeopleConf[signData.orgType]?this.specialPeopleConf[signData.orgType]:signData.orgName,orgId:this.specialPeopleConf[signData.orgType]?signData.orgType:signData.orgId,isDom:!0}],this.peopleListLongitudinalDom)),this.S("#peopleScrollLongitudinal").liMarquee("update"),this.recordNewSign.push({type:"Longitudinal",orgId:this.specialPeopleConf[signData.orgType]?signData.orgType:signData.orgId})},updatePeopleListForLandscape:function(signData){this.S("#peopleScrollLandscapeUL").append(this.updateDom([{orgName:signData.orgName,orgId:signData.orgId,isDom:!0}],this.peopleListLandscapeDom)),this.recordNewSign.push({type:"Landscape",orgId:signData.orgId}),this.calcPeopleScrollLandscapeWidth(),this.S("#peopleScrollLandscape").liMarquee("update")},calcPeopleScrollLandscapeWidth:function(){var domWidth=0;this.S("#peopleScrollLandscapeUL li").each(function(index,ele){domWidth+=this.S(ele).width()}.bind(this)),this.peopleScrollLandscapeWidth=domWidth+1},updateApproachPeopleList:function(signData){if("IN"==signData.action){var isExist=!1;if(this.S("#approachPeopleWrapper li").each(function(index,ele){ele.getAttribute("approach-domid")==signData.userId&&(isExist=!0)}),isExist)return;this.S(".str_origin",this.S("#approachPeopleWrapper")).html(this.S(".str_origin",this.S("#approachPeopleWrapper")).html()+this.updateDom([{orgName:signData.orgName,orgId:signData.userName,isDom:!0}],this.approachPeopleDom,!0,signData.userId))}else"OUT"==signData.action&&this.S("#approachPeopleWrapper li").each(function(index,ele){ele.getAttribute("approach-domid")==signData.userId&&ele.remove()});this.S("#approachPeopleWrapper").liMarquee("update")},peopleSign:function(signData){this.peopleData=signData,signData.gateCode==this.gateCode&&this.showPeoplePanel(),!this.updatePeopleNumber(this.peopleLongitudinalList,this.specialPeopleConf[signData.orgType]?signData.orgType:signData.orgId,!0,this.recordNewSign,"Longitudinal")&&this.specialPeopleConf[signData.orgType]&&this.updatePeopleListForLongitudinal(signData),this.updatePeopleNumber(this.peopleListLandscape,signData.orgId,!0,this.recordNewSign,"Landscape")||"Operator"!=signData.orgType||this.updatePeopleListForLandscape(signData),this.updateApproachPeopleList(signData),this.approachpPeopleNum++},peopleExit:function(signData){this.peopleData=signData,signData.gateCode==this.gateCode&&this.showPeoplePanel(),this.updatePeopleNumber(this.peopleListLandscape,signData.orgId,!1,this.recordNewSign,"Landscape"),this.delSignedPeople("Landscape"),this.updatePeopleNumber(this.peopleLongitudinalList,this.specialPeopleConf[signData.orgType]?signData.orgType:signData.orgId,!1,this.recordNewSign,"Longitudinal"),this.delSignedPeople("Longitudinal"),this.approachpPeopleNum&&this.approachpPeopleNum--,this.updateApproachPeopleList(signData)},delSignedPeople:function(ident){for(var i=0;i<this.recordNewSign.length;i++)if(this.recordNewSign[i].type==ident){this.recordNewSign.splice(i,1);break}},showPeoplePanel:function(){this.isSign=!0,setTimeout(function(){this.isSign=!1}.bind(this),this.hiddenTimer)},updatePeopleNumber:function(updateArrs,orgId,flag,recordNewSignArrs,dataFlag){var exist=!1;return updateArrs.forEach(function(d){orgId==d.orgId&&(flag?d.count++:d.count&&d.count--,exist=!0)}.bind(this)),recordNewSignArrs&&recordNewSignArrs.length>0&&recordNewSignArrs.forEach(function(d){if(orgId==d.orgId&&dataFlag==d.type){var dom=this.S("[data-dom=isDomEle"+d.type+orgId+"]").eq(0);flag?dom.text(Number(dom.text())+1):dom.text(Number(dom.text())?Number(dom.text())-1:0)}}.bind(this)),exist||this.recordNewSign.filter(function(d){return d.type==dataFlag&&d.orgId==orgId}).length},updateDom:function(data,doms,flag,uid){var domStr="";return data.forEach(function(d){domStr+=String.format(doms,d.orgName,d.orgId,flag?uid:1)}),domStr},simulateCall:function(){}}}).init()});